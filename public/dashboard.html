<!DOCTYPE html>
<html lang="en">


<style>
    body {
      font-family: 'Poppins', sans-serif;
    }

    #alerta {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #b10202;
      color: white;
      padding: 3vh;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 9999;
      display: none;
      width: 500px;
      height: 150px;

      animation: fadein 0.5s, fadeout 0.5s 4.5s;
    }

    .num_kpi {
      font-size: 30px;
      font-weight: 700;
    }
    

    @keyframes fadein {
      from {opacity: 0; transform: translateY(-10px);}
      to {opacity: 1; transform: translateY(0);}
    }

    @keyframes fadeout {
      from {opacity: 1; transform: translateY(0);}
      to {opacity: 0; transform: translateY(-10px);}
    }

    
  </style>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/styles/dash.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" href="assets/image/logoMD.jpg" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=dashboard" />
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <title>Monitoramento térmico</title>
</head>

<body>
  <div class="menulateral">
    <img src="assets/image/logo2.svg">

    <div class="imgcliente">
      <div class="fotouser">
        <img src="assets/image/default-avatar-icon-of-social-media-user-vector.jpg">
      </div>
      <div class="nomeuser">
        <h2>Grupo MedSul</h2>
      </div>
    </div>

    <hr class="line">

    <div class="navegacao">

      <div id="alerta"></div>

      <ul>
        <li class="icon">
          <img src="assets/image/dashicon.svg">
          <a href="dashboard.html"> Dashboard</a>
        </li>

        <li class="icon">
          <img src="assets/image/alerticon.svg">
          <a href="alertasDash.html"> Alertas</a>
        </li>

        <li class="icon">
          <img src="assets/image/jira.svg" alt="" style="width: 30px;">
          <a href="https://medsense.atlassian.net/servicedesk/customer/portal/1" target="_blank">Central de ajuda</a>
        </li>
      </ul>

    </div>

    <div class="logout">
      <a href="index.html" style="text-decoration: none; color: rgb(255, 0, 0);">
        <p>Sair</p>
      </a>
    </div>
  </div>

  <div class="geral">
    <div class="titulo">
      <h1>Monitoramento térmico de medicamentos</h1>
    </div>


    <div class="legenda">
      <div class="temp">
        <p style="color: navy;"> Temperatura ideal:</p><span>2ºC a 8ºC</span>
      </div>
      <div class="umidade">
        <p style="color: navy;"> Umidade ideal: </p><span> 40% a 70%</span>
      </div>
    </div>


    <div class="infos1">
      <h3>Número da geladeira:
        <select name="" id="geladeira"
          style="color: navy; border: none; outline: none; font-size: large; font-family: 'Poppins'; font-weight: 600;">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </h3>

      <h3>Setor: 1
        <div id="setorTroca">
        </div>
      </h3>

    
    </div>

    <div class="kpis">
      <div class="indicador" style="background-color: navy;">
        <h3>Ultimo registro <br> fora do conforme </h3>
        <p id="kpi_temp_media" class="num_kpi"></p>
      </div>
      <div class="indicador" style="background-color: navy;">
        <h3>Setor com <br> mais ocorrências </h3>
        <p id="kpi_setor_ocorrencias"  class="num_kpi"></p>
      </div>
      <div class="indicador" style="background-color: rgb(11, 143, 11);">
        <h3>Dias sem alertas <br> (últimos 30 dias)</h3>
        <p id="kpi_conformidade"  class="num_kpi"></p>
      </div>
      <div class="indicador" style="background-color: rgb(133, 7, 7);">
        <h3>Alertas emitidos <br> esse mês</h3>
        <p id="kpi_alertas_mes"  class="num_kpi"></p>
      </div>
    </div>

    <!-- gráficos  -->

    <div class="graficos">

      <div class="graficoTemp">
        <h2>Captura de Temperatura</h2>
        <div>
          <canvas id="myChart" ></canvas>
          <canvas id="myChart3"></canvas>
          <canvas id="myChart5"></canvas>

        </div>
      </div>

      <div class="graficoUmid">
        <h2>Captura de Umidade</h2>
        <div>
          <canvas id="myChart2"></canvas>
          <canvas id="myChart4"></canvas>
          <canvas id="myChart6"></canvas>
        </div>
      </div>

    </div>
  </div>

  
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
<script>
  var ctx;
  var ctx2; 


  let proximaAtualizacao;


  window.onload = () => {

  ctx = document.getElementById('myChart');
  ctx2 = document.getElementById('myChart2');
  ctx3 = document.getElementById('myChart3');
  ctx4 = document.getElementById('myChart4');
  ctx5 = document.getElementById('myChart5');
  ctx6 = document.getElementById('myChart6');

  const selecionarGeladeira = document.getElementById('geladeira');
  let geladeiraAtual = selecionarGeladeira.value;
  let intervaloAtualizacao;

  function carregarDadosGeladeira(geladeira) {
    if (intervaloAtualizacao) clearInterval(intervaloAtualizacao);
    
    document.querySelectorAll('canvas').forEach(canvas => {
      canvas.style.display = 'none';
    });

    if (geladeira == 1) {
      document.getElementById('myChart').style.display = 'block';
      document.getElementById('myChart2').style.display = 'block';
      obterDadosGrafico(geladeira);
      obterDadosGrafico2(geladeira);
    } else if (geladeira == 2) {
      document.getElementById('myChart3').style.display = 'block';
      document.getElementById('myChart4').style.display = 'block';
      obterDadosGrafico3(geladeira);
      obterDadosGrafico4(geladeira);
    } else if (geladeira == 3) {
      document.getElementById('myChart5').style.display = 'block';
      document.getElementById('myChart6').style.display = 'block';
      obterDadosGrafico5(geladeira);
      obterDadosGrafico6(geladeira);
    }

    atualizarKPIs(geladeira);
    
      intervaloAtualizacao = setInterval(() => {
      simularDadosArduino(geladeira);
      atualizarTempoReal(geladeira);
      atualizarKPIs(geladeira);
    }, 5000);
  }

  // atualizar dados em tempo real
  function atualizarTempoReal(geladeira) {
    if (geladeira == 1) {
      buscarTemperaturaEmTempoReal();
      buscarUmidadeEmTempoReal();
    } else if (geladeira == 2) {
      buscarTemperaturaEmTempoReal2();
      buscarUmidadeEmTempoReal2();
    } else if (geladeira == 3) {
      buscarTemperaturaEmTempoReal3();
      buscarUmidadeEmTempoReal3();
    }
  }

  function atualizarKPIs(geladeira) {
    if (geladeira == 1) {
      buscarUltimoDesvio();
      buscarDiasSemDesvio();
      buscarSetorComDesvio();
      buscarAlertas();
    } else if (geladeira == 2) {
      buscarUltimoDesvio2();
      buscarDiasSemDesvio2();
      buscarSetorComDesvio2();
      buscarAlertas2();
    } else if (geladeira == 3) {
      buscarUltimoDesvio3();
      buscarDiasSemDesvio3();
      buscarSetorComDesvio3();
      buscarAlertas3();
    }
  }

  function simularDadosArduino(geladeira) {
    if (geladeira == 1) {
   //   simularArduino();
    } else if (geladeira == 2) {
      simularArduino2();
    } else if (geladeira == 3) {
      simularArduino3();
    }
  }

  selecionarGeladeira.addEventListener('change', () => {
    geladeiraAtual = selecionarGeladeira.value;
    carregarDadosGeladeira(geladeiraAtual);
  });

  carregarDadosGeladeira(geladeiraAtual);
};





  const selecionarGeladeira = document.getElementById('geladeira');

  function simularBaseadoNoSelect() {
    const geladeira = selecionarGeladeira.value;

    // if (geladeira == '1') {
    //   simularArduino();
    // } else
      if (geladeira == '2') {
      simularArduino2();
    } else if (geladeira == '3') {
      simularArduino3();
    }
  }



  // function simularArduino() {

  //   var umidade = (Math.random() * 100).toFixed();
  //   var temperatura = (Math.random() * 10).toFixed(1);
  //   console.log(umidade, temperatura);



  //   fetch("/medidas/inseriraleatorio", {
  //     method: "POST",
  //     headers: {
  //       "Content-Type": "application/json",
  //     },
  //     body: JSON.stringify({

  //       randTemperatura: temperatura,
  //       randUmidade: umidade,
  //       fkSensorServer: 2

  //     }),
  //   })
  //     .then(function (resposta) {
  //       console.log("resposta: ", resposta);

  //       if (resposta.ok) {
  //         console.log("Resposta ok");
  //       } else {
  //         throw "deu ruim na resposta!";
  //         alert("deu ruim na resposta!");
  //       }
  //     })
  //     .catch(function (resposta) {
  //       console.log(`#ERRO: ${resposta}`);

  //     });

  //}



  function simularArduino2() {

    var umidade = (Math.random() * 100).toFixed();
    var temperatura = (Math.random() * 10).toFixed(1);
    console.log(umidade, temperatura);



    fetch("/medidas/inseriraleatorio2", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({

        randTemperatura: temperatura,
        randUmidade: umidade,
        fkSensorServer: 2

      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          console.log("Resposta ok");
        } else {
          throw "deu ruim na resposta!";
          alert("deu ruim na resposta!");
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);

      });




  }



  function simularArduino3() {

    var umidade = (Math.random() * 100).toFixed();
    var temperatura = (Math.random() * 10).toFixed(1);
    console.log(umidade, temperatura);



    fetch("/medidas/inseriraleatorio3", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({

        randTemperatura: temperatura,
        randUmidade: umidade,
        fkSensorServer: 2

      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          console.log("Resposta ok");
        } else {
          throw "deu ruim na resposta!";
          alert("deu ruim na resposta!");
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);

      });




  }



let myChart = null;
let myChart2 = null;
let myChart3 = null;
let myChart4 = null;
let myChart5 = null
let myChart6 = null

function destroyChart(chartInstance) {
    if (chartInstance && typeof chartInstance.destroy == 'function') {
        chartInstance.destroy();
    }
    return null;
}

   function trocarGrafico(geladeira) {
    console.log(`Trocando para geladeira ${geladeira}`);
    
    myChart = destroyChart(myChart);
    myChart2 = destroyChart(myChart2);
    myChart3 = destroyChart(myChart3);
    myChart4 = destroyChart(myChart4);
    myChart5 = destroyChart(myChart5)
    myChart6 = destroyChart(myChart6)
    
    document.querySelectorAll('canvas').forEach(canvas => {
        canvas.style.display = 'none';
    });

    if (geladeira == 1) {
         fetch("/medidas/inserirarduino", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ fkSensorServer: 2 })
          })
          
          // .catch(() => {
          //   simularArduino();
          // });

          document.getElementById('myChart').style.display = 'block';
          document.getElementById('myChart2').style.display = 'block';

        obterDadosGrafico(1);    
        obterDadosGrafico2(1);   
        
    } else if (geladeira == 2) {

        document.getElementById('myChart3').style.display = 'block';
        document.getElementById('myChart4').style.display = 'block';
                
        obterDadosGrafico3(2);   
        obterDadosGrafico4(2);   
    }
      else if (geladeira == 3) {

        document.getElementById('myChart5').style.display = 'block';
        document.getElementById('myChart6').style.display = 'block';
                
        obterDadosGrafico5(3);   
        obterDadosGrafico6(3);   
    }
}









  function obterDadosGrafico(temperatura) {

    fetch(`/medidas/ultimas/temperatura`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {

          

          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarctx(resposta);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }



  function plotarctx(resposta) {
    console.log('iniciando plotagem do gráfico...');


    var dados = {
      labels: [],
      datasets: [
        {
          label: 'Temperatura',
          borderColor: '#32B9CD',
          data: []
        }
      ]
    };



    for (i = resposta.length - 1; i >= 0; i--) {
      var registro = resposta[i];
      dados.labels.push(registro.horario);
      dados.datasets[0].data.push(registro['temperatura']);
    }
  
    myChart = destroyChart(myChart);

    

    window.myChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dados.labels,
        datasets: [{
          label: 'Temperatura',
          data: dados.datasets[0].data,
          backgroundColor: 'navy',
          borderColor: 'navy',
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          annotation: {
            annotations: {
              faixaIdeal: {
                type: 'box',
                yMin: 2,
                yMax: 8,
                backgroundColor: 'rgba(0, 0, 128, 0.1)',
                borderColor: 'navy',
                borderWidth: 1,
              },
              limiteMin: {
                type: 'line',
                yMin: 2,
                yMax: 2,
                borderColor: 'blue',
                borderWidth: 1,
                borderDash: [6, 6],
                label: {
                  content: 'Mínimo (2°C)',
                  enabled: true,
                  position: 'start'
                }
              },
              limiteMax: {
                type: 'line',
                yMin: 8,
                yMax: 8,
                borderColor: 'red',
                borderWidth: 1,
                borderDash: [6, 6],
                label: {
                  content: 'Máximo (8°C)',
                  enabled: true,
                  position: 'start'
                }
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });

    
  }

  function obterDadosGrafico2(umidade) {

    fetch(`/medidas/ultimas/umidade`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {

          

          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarctx2(resposta);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }


  function plotarctx2(resposta) {
    console.log('iniciando plotagem do gráfico...');


    
    var dados = {
      labels: [],
      datasets: [
        {
          label: 'Umidade',
          borderColor: '#32B9CD',
          data: []
        }
      ]
    };



    for (i = resposta.length - 1; i >= 0; i--) {
      var registro = resposta[i];
      dados.labels.push(registro.horario);
      dados.datasets[0].data.push(registro['umidade']);
    }

    
    myChart = destroyChart(myChart2);

    window.myChart2 = new Chart(ctx2, {
      type: 'line',
      data: {
        labels: dados.labels,
        datasets: [{
          label: 'Umidade',
          data: dados.datasets[0].data,
          backgroundColor: '#03459c',
          borderColor: 'navy',
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          annotation: {
            annotations: {
              faixaIdeal: {
                type: 'box',
                yMin: 40,
                yMax: 70,
                backgroundColor: 'rgba(0, 0, 128, 0.1)', // faixa azul clara
                borderColor: 'navy',
                borderWidth: 1,
              },
              limiteMin: {
                type: 'line',
                yMin: 40,
                yMax: 40,
                borderColor: 'blue',
                borderWidth: 1,
                borderDash: [6, 6],
                label: {
                  content: 'Limite Mínimo',
                  enabled: true,
                  position: 'start'
                }
              },
              limiteMax: {
                type: 'line',
                yMin: 70,
                yMax: 70,
                borderColor: 'red',
                borderWidth: 2,
                borderDash: [6, 6],
                label: {
                  content: 'Limite Máximo',
                  enabled: true,
                  position: 'start'
                }
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });
  }


  function buscarTemperaturaEmTempoReal() {
    fetch(`/medidas/tempo-real/temperatura`, { cache: 'no-store' })
      .then(response => response.json()) //Converte de json para o novoRegistro
      .then(novoRegistro => { //Aqui você chama os dados que acabou de converter
        const registro = novoRegistro[0];
        const chart = window.myChart;

        chart.data.labels.push(registro.horario);
        chart.data.datasets[0].data.push(registro.temperatura);

        // Quando o grafico chegar a 8 de registros ele apaga e passa pro proximo
        if (chart.data.labels.length > 8) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }

        // Funcionalidade da bibliteca chart JS, ele atualiza sozinho
        chart.update();

        if (registro.temperatura < 2 || registro.temperatura > 8) {
            mostrarAlerta(registro.temperatura, null);
        }

      })
      .catch(error => console.error("Erro ao buscar temperatura tempo real:", error));
  }

  function buscarUmidadeEmTempoReal() {
    fetch(`/medidas/tempo-real/umidade`, { cache: 'no-store' })
      .then(response => response.json()) //Converte de json para o novoRegistro
      .then(novoRegistro => { //Aqui você chama os dados que acabou de converter
        const registro = novoRegistro[0];
        const chart = window.myChart2;

        chart.data.labels.push(registro.horario);
        chart.data.datasets[0].data.push(registro.umidade);

        // Quando o grafico chegar a 8 de registros ele apaga e passa pro proximo
        if (chart.data.labels.length > 8) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }

        // Funcionalidade da bibliteca chart JS, ele atualiza sozinho
        chart.update();
        if (registro.umidade < 40 || registro.umidade > 70) {
            mostrarAlerta(null, registro.umidade);
        }

      })
      .catch(error => console.error("Erro ao buscar temperatura tempo real:", error));
  }









  function buscarUltimoDesvio() {

    
    fetch(`/medidas/buscarUltimoDesvio`)
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

            const ultimoRegistro = resposta[0]['Ultimo registro fora do conforme'];
            document.getElementById("kpi_temp_media").textContent = ultimoRegistro;

          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }



  function buscarDiasSemDesvio() {

    fetch(`/medidas//buscarDiasSemDesvio`)
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

            const diasSemAnormalidades = resposta[0]["Dias sem anormalidades"];
            document.getElementById("kpi_conformidade").textContent = diasSemAnormalidades + " dias";

          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }




  function buscarSetorComDesvio() {

    fetch(`/medidas/buscarSetorComDesvio`)
    .then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidossssssssss: ${JSON.stringify(resposta)}`);

          const setor = resposta[0].setor;
          document.getElementById("kpi_setor_ocorrencias").textContent = "Setor" + setor;

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }




  function buscarAlertas() {

    fetch(`/medidas//buscarAlertas`)
    .then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          mostrarAlerta()

           const totalAlertas = resposta[0].total_alertas;
        console.log(`Total de alertas: ${totalAlertas}`);
        document.getElementById('kpi_alertas_mes').textContent = `Alertas: ${totalAlertas}`;

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }




































function obterDadosGrafico3(temperatura) {

    fetch(`/medidas/ultimas/temperatura2`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {

          

          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarctx3(resposta);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }


  function plotarctx3(resposta) {
    console.log('iniciando plotagem do gráfico...');


    var dados = {
      labels: [],
      datasets: [
        {
          label: 'Temperatura',
          borderColor: '#32B9CD',
          data: []
        }
      ]
    };



    for (i = resposta.length - 1; i >= 0; i--) {
      var registro = resposta[i];
      dados.labels.push(registro.horario);
      dados.datasets[0].data.push(registro['temperatura']);
    }

    myChart = destroyChart(myChart3);


    window.myChart3 = new Chart(ctx3, {
      type: 'line',
      data: {
        labels: dados.labels,
        datasets: [{
          label: 'Temperatura',
          data: dados.datasets[0].data,
          backgroundColor: 'navy',
          borderColor: 'navy',
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          annotation: {
            annotations: {
              faixaIdeal: {
                type: 'box',
                yMin: 2,
                yMax: 8,
                backgroundColor: 'rgba(0, 0, 128, 0.1)',
                borderColor: 'navy',
                borderWidth: 1,
              },
              limiteMin: {
                type: 'line',
                yMin: 2,
                yMax: 2,
                borderColor: 'blue',
                borderWidth: 1,
                borderDash: [6, 6],
                label: {
                  content: 'Mínimo (2°C)',
                  enabled: true,
                  position: 'start'
                }
              },
              limiteMax: {
                type: 'line',
                yMin: 8,
                yMax: 8,
                borderColor: 'red',
                borderWidth: 1,
                borderDash: [6, 6],
                label: {
                  content: 'Máximo (8°C)',
                  enabled: true,
                  position: 'start'
                }
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });

    
  }

  function obterDadosGrafico4(umidade) {

    fetch(`/medidas/ultimas/umidade2`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {

          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarctx4(resposta);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }


  function plotarctx4(resposta) {
    console.log('iniciando plotagem do gráfico...');

    

    var dados = {
      labels: [],
      datasets: [
        {
          label: 'Umidade',
          borderColor: '#32B9CD',
          data: []
        }
      ]
    };



    for (i = resposta.length - 1; i >= 0; i--) {
      var registro = resposta[i];
      dados.labels.push(registro.horario);
      dados.datasets[0].data.push(registro['umidade']);
    }

    const ctx4 = document.getElementById('myChart4');

    myChart = destroyChart(myChart4);


    window.myChart4 = new Chart(ctx4, {
      type: 'line',
      data: {
        labels: dados.labels,
        datasets: [{
          label: 'Umidade',
          data: dados.datasets[0].data,
          backgroundColor: '#03459c',
          borderColor: 'navy',
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          annotation: {
            annotations: {
              faixaIdeal: {
                type: 'box',
                yMin: 40,
                yMax: 70,
                backgroundColor: 'rgba(0, 0, 128, 0.1)', // faixa azul clara
                borderColor: 'navy',
                borderWidth: 1,
              },
              limiteMin: {
                type: 'line',
                yMin: 40,
                yMax: 40,
                borderColor: 'blue',
                borderWidth: 1,
                borderDash: [6, 6],
                label: {
                  content: 'Limite Mínimo',
                  enabled: true,
                  position: 'start'
                }
              },
              limiteMax: {
                type: 'line',
                yMin: 70,
                yMax: 70,
                borderColor: 'red',
                borderWidth: 2,
                borderDash: [6, 6],
                label: {
                  content: 'Limite Máximo',
                  enabled: true,
                  position: 'start'
                }
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });
  }


  function buscarTemperaturaEmTempoReal2() {
    fetch(`/medidas/tempo-real/temperatura2`, { cache: 'no-store' })
      .then(response => response.json()) 
      .then(novoRegistro => { 
        const registro = novoRegistro[0];
            const chart = window.myChart3; 

        chart.data.labels.push(registro.horario);
        chart.data.datasets[0].data.push(registro.temperatura);

        if (chart.data.labels.length > 8) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }

        chart.update();
        
        if (registro.temperatura < 2 || registro.temperatura > 8) {
            mostrarAlerta(registro.temperatura, null);
        }
      })
      .catch(error => console.error("Erro ao buscar temperatura tempo real:", error));
  }

  function buscarUmidadeEmTempoReal2() {
    fetch(`/medidas/tempo-real/umidade2`, { cache: 'no-store' })
      .then(response => response.json()) 
      .then(novoRegistro => { 
        const registro = novoRegistro[0];
        const chart = window.myChart4; 


        chart.data.labels.push(registro.horario);
        chart.data.datasets[0].data.push(registro.umidade);

        if (chart.data.labels.length > 8) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }

        chart.update();
        if (registro.umidade < 40 || registro.umidade > 70) {
            mostrarAlerta(null, registro.umidade);
        }
      })
      .catch(error => console.error("Erro ao buscar temperatura tempo real:", error));
  }









  function buscarUltimoDesvio2() {

    
    fetch(`/medidas/buscarUltimoDesvio2`)
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

            const ultimoRegistro = resposta[0]['Ultimo registro fora do conforme'];
            document.getElementById("kpi_temp_media").textContent = ultimoRegistro;

          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }



  function buscarDiasSemDesvio2() {

    fetch(`/medidas/buscarDiasSemDesvio2`)
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

            const diasSemAnormalidades = resposta[0]["Dias sem anormalidades"];
            document.getElementById("kpi_conformidade").textContent = diasSemAnormalidades + " dias";

          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }




  function buscarSetorComDesvio2() {

    fetch(`/medidas//buscarSetorComDesvio2`)
    .then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidossssssssss: ${JSON.stringify(resposta)}`);

          const setor = resposta[0].setor;
          document.getElementById("kpi_setor_ocorrencias").textContent = setor;

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }




  function buscarAlertas2() {

    fetch(`/medidas//buscarAlertas2`)
    .then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          mostrarAlerta()

           const totalAlertas = resposta[0].total_alertas;
        console.log(`Total de alertas: ${totalAlertas}`);
        document.getElementById('kpi_alertas_mes').textContent = `Alertas: ${totalAlertas}`;

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }






















  function obterDadosGrafico5(temperatura) {

    fetch(`/medidas/ultimas/temperatura3`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {

          

          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarctx5(resposta);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }


  function plotarctx5(resposta) {
    console.log('iniciando plotagem do gráfico...');


    var dados = {
      labels: [],
      datasets: [
        {
          label: 'Temperatura',
          borderColor: '#32B9CD',
          data: []
        }
      ]
    };



    for (i = resposta.length - 1; i >= 0; i--) {
      var registro = resposta[i];
      dados.labels.push(registro.horario);
      dados.datasets[0].data.push(registro['temperatura']);
    }

    myChart = destroyChart(myChart5);


    window.myChart5 = new Chart(ctx5, {
      type: 'line',
      data: {
        labels: dados.labels,
        datasets: [{
          label: 'Temperatura',
          data: dados.datasets[0].data,
          backgroundColor: 'navy',
          borderColor: 'navy',
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          annotation: {
            annotations: {
              faixaIdeal: {
                type: 'box',
                yMin: 2,
                yMax: 8,
                backgroundColor: 'rgba(0, 0, 128, 0.1)',
                borderColor: 'navy',
                borderWidth: 1,
              },
              limiteMin: {
                type: 'line',
                yMin: 2,
                yMax: 2,
                borderColor: 'blue',
                borderWidth: 1,
                borderDash: [6, 6],
                label: {
                  content: 'Mínimo (2°C)',
                  enabled: true,
                  position: 'start'
                }
              },
              limiteMax: {
                type: 'line',
                yMin: 8,
                yMax: 8,
                borderColor: 'red',
                borderWidth: 1,
                borderDash: [6, 6],
                label: {
                  content: 'Máximo (8°C)',
                  enabled: true,
                  position: 'start'
                }
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });

    
  }

  function obterDadosGrafico6(umidade) {

    fetch(`/medidas/ultimas/umidade3`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {

          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarctx6(resposta);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }


  function plotarctx6(resposta) {
    console.log('iniciando plotagem do gráfico...');

    

    var dados = {
      labels: [],
      datasets: [
        {
          label: 'Umidade',
          borderColor: '#32B9CD',
          data: []
        }
      ]
    };



    for (i = resposta.length - 1; i >= 0; i--) {
      var registro = resposta[i];
      dados.labels.push(registro.horario);
      dados.datasets[0].data.push(registro['umidade']);
    }

    const ctx6 = document.getElementById('myChart6');

    myChart = destroyChart(myChart6);


    window.myChart6 = new Chart(ctx6, {
      type: 'line',
      data: {
        labels: dados.labels,
        datasets: [{
          label: 'Umidade',
          data: dados.datasets[0].data,
          backgroundColor: '#03459c',
          borderColor: 'navy',
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          annotation: {
            annotations: {
              faixaIdeal: {
                type: 'box',
                yMin: 40,
                yMax: 70,
                backgroundColor: 'rgba(0, 0, 128, 0.1)', // faixa azul clara
                borderColor: 'navy',
                borderWidth: 1,
              },
              limiteMin: {
                type: 'line',
                yMin: 40,
                yMax: 40,
                borderColor: 'blue',
                borderWidth: 1,
                borderDash: [6, 6],
                label: {
                  content: 'Limite Mínimo',
                  enabled: true,
                  position: 'start'
                }
              },
              limiteMax: {
                type: 'line',
                yMin: 70,
                yMax: 70,
                borderColor: 'red',
                borderWidth: 2,
                borderDash: [6, 6],
                label: {
                  content: 'Limite Máximo',
                  enabled: true,
                  position: 'start'
                }
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });
  }


  function buscarTemperaturaEmTempoReal3() {
    fetch(`/medidas/tempo-real/temperatura3`, { cache: 'no-store' })
      .then(response => response.json()) 
      .then(novoRegistro => { 
        const registro = novoRegistro[0];
            const chart = window.myChart5; 

        chart.data.labels.push(registro.horario);
        chart.data.datasets[0].data.push(registro.temperatura);

        if (chart.data.labels.length > 8) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }

        chart.update();

        if (registro.temperatura < 2 || registro.temperatura > 8) {
            mostrarAlerta(registro.temperatura, null);
        }

      })
      .catch(error => console.error("Erro ao buscar temperatura tempo real:", error));
  }

  function buscarUmidadeEmTempoReal3() {
    fetch(`/medidas/tempo-real/umidade3`, { cache: 'no-store' })
      .then(response => response.json()) 
      .then(novoRegistro => { 
        const registro = novoRegistro[0];
        const chart = window.myChart6; 


        chart.data.labels.push(registro.horario);
        chart.data.datasets[0].data.push(registro.umidade);

        if (chart.data.labels.length > 8) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }

        chart.update();
        if (registro.umidade < 40 || registro.umidade > 70) {
            mostrarAlerta(null, registro.umidade);
        }
      })
      .catch(error => console.error("Erro ao buscar temperatura tempo real:", error));
  }









  function buscarUltimoDesvio3() {

    
    fetch(`/medidas/buscarUltimoDesvio3`)
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

            const ultimoRegistro = resposta[0]['Ultimo registro fora do conforme'];
            document.getElementById("kpi_temp_media").textContent = ultimoRegistro;

          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }



  function buscarDiasSemDesvio3() {

    fetch(`/medidas//buscarDiasSemDesvio3`)
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

            const diasSemAnormalidades = resposta[0]["Dias sem anormalidades"];
            document.getElementById("kpi_conformidade").textContent = diasSemAnormalidades + " dias";

          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }




  function buscarSetorComDesvio3() {

    fetch(`/medidas//buscarSetorComDesvio3`)
    .then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidossssssssss: ${JSON.stringify(resposta)}`);

          const setor = resposta[0].setor;
          document.getElementById("kpi_setor_ocorrencias").textContent = setor;

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }




  function buscarAlertas3() {

    fetch(`/medidas//buscarAlertas3`)
    .then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          mostrarAlerta()

           const totalAlertas = resposta[0].total_alertas;
        console.log(`Total de alertas: ${totalAlertas}`);
        document.getElementById('kpi_alertas_mes').textContent = `Alertas: ${totalAlertas}`;

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }








let ultimaTemperatura = null;
let ultimaUmidade = null;
let alertaAtivo = false;
let timeoutAlerta = null;

function mostrarAlerta(temperatura, umidade) {
    if (temperatura === undefined && umidade === undefined) return;
    
    const temperaturaFora = temperatura !== undefined && (temperatura < 2 || temperatura > 8);
    const umidadeFora = umidade !== undefined && (umidade < 40 || umidade > 70);
    
    if ((temperaturaFora || umidadeFora) && 
        (temperatura !== ultimaTemperatura || umidade !== ultimaUmidade || 
         ultimaTemperatura === null || ultimaUmidade === null)) {
        
        if (timeoutAlerta) {
            clearTimeout(timeoutAlerta);
        }
        
        if (temperatura !== undefined) ultimaTemperatura = temperatura;
        if (umidade !== undefined) ultimaUmidade = umidade;
        
        alertaAtivo = true;
        const alerta = document.getElementById('alerta');
        
        let mensagem = '<h3>⚠️ ALERTA! <h3>';
        
        mensagem += '<p>OS VALORES ESTÃO FORA DA FAIXA IDEAL, VÁ PARA A SESSÃO DE ALERTAS AGORA!(Faixa ideal: 2°C a 8°C e 40% a 70%)<p/>';
        
        alerta.innerHTML = mensagem;
        alerta.style.display = 'block';

        timeoutAlerta = setTimeout(() => {
            alerta.style.display = 'none';
            alertaAtivo = false;
        }, 5000);
    }
}
</script>